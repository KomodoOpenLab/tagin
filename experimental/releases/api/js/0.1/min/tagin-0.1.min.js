/**
 * tagin!, a WiFi-based point-of-interest (POI) service
 * for tagging outdoor and indoor locations
 * Copyright (c) 2009, University of Toronto
 * scyp@atrc.utoronto.ca
 *
 * Dual licensed under the MIT and GPL licenses.
 * http://scyp.atrc.utoronto.ca/projects/tagin/license
 * 
 * @author Susahosh Rahman
 * @email susahosh.rahman@utoronto.ca
 **/
var tagin=tagin||{}; (function(d){var u={responseHandler:function(){},errorHandler:function(){},updateStatus:function(){}},m=false,k=function(){if(!m)throw"tagin! API has not been initialized. Did you forget to call the loadTagin() function?";return true},v=function(a,b){for(var c in b)if(typeof a[c]!==typeof b[c])return false;return true},w="",f=function(a,b){if(!a||!b)return"";return"<"+a+">"+b+"</"+a+">"},n=function(a,b){return b?a+b:a},x=function(a,b,c){b||c||d.clientInterface.updateStatus("Warning: sending empty request to server!");return n(n('<?xml version="1.0"?>', w),f("client_message",n(n(f("message_type",a),c),b)))},y=function(a){if(!a)return null;try{var b=a.split(/,/);a="";for(var c=0;c<b.length;c++)a+=f("tag",b[c].trim());return f("tags",a)}catch(e){return null}},z=function(a){var b="";b+=f("unit",a.room);b+=f("floor",a.floor);b+=f("building_name",a.building);b+=f("street",a.street);b+=f("city",a.city);b+=f("province",a.province);b+=f("country",a.country);b+=f("postal",a.postal);if(!b)return b;return f("location",b)},A=function(a){if(!a||a.length===0)return null; for(var b="",c=0;c<a.length;c++){var e=a[c];b+=f("ap",f("mac",e.mac)+f("strength",e.strength)+f("channel",e.channel)+f("mode",e.mode))}return f("scans",f("scan",b))},B=function(a){var b=null;try{var c=new DOMParser;b=c.parseFromString(a,"text/xml")}catch(e){try{b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a)}catch(g){d.clientInterface.errorHandler(g);return null}}return b},s=function(a,b){try{return a.getElementsByTagName(b)[0].childNodes[0].nodeValue}catch(c){return null}},C= function(a){if(!a)return null;var b=[],c=a.getElementsByTagName("tag");if(c.length===0){c=a.getElementsByTagName("tags");if(c.length===1)return b;return null}for(a=0;a<c.length;a++){var e=c[a],g=s(e,"value"),j=s(e,"distance");e=s(e,"frequency");if(!(g&&j&&e))return null;b[a]=new d.dataManager.Tag(g,j,e)}return b},o=function(a,b){var c=null;try{var e=a.getElementsByTagName(b);c=e[0].childNodes[0].nodeValue}catch(g){return null}return c},h=function(a,b){if(!b)return"";return(a=o(a,b))?a:""},D=function(a){if(!a)return null; var b=h(a,"room"),c=h(a,"floor"),e=h(a,"building"),g=h(a,"street"),j=h(a,"city"),p=h(a,"province"),q=h(a,"country");a=h(a,"postal");if(!(!b&&!c&&!e&&!g&&!j&&!p&&!q&&!a))return new d.dataManager.Location(b,c,e,g,j,p,q,a)},i,l=function(a,b,c){b===null?d.clientInterface.errorHandler(c):d.clientInterface.responseHandler(new d.serverResponse.Response(a,a==="error"?"Server error: "+b:b))},E=function(a){var b=o(a,"response_type");switch(b){case null:d.clientInterface.errorHandler("Received invalid response"); break;case "all_visible_tags":l(b,C(a),"Error retriving tags from response.");break;case "current_location":l(b,D(a),"Error retriving current location from response.");break;case "message":l(b,o(a,"message"),"Error retriving message from response.");break;case "error":l(b,o(a,"error"),"Error retriving information from response.");break;default:l("message","Invalid response from server.","");break}},F=function(){if(i.readyState===4)if(i.status===200){var a=B(i.responseText);a?E(a):d.clientInterface.errorHandler("Error parsing response.")}else d.clientInterface.errorHandler("Error contacting server.")}, G=function(a){i=new XMLHttpRequest;var b="http://noodle.atrc.utoronto.ca",c="8000";b=b;i.open("POST",b+":"+c+"/",true);i.onreadystatechange=F;i.overrideMimeType("text/plain; charset=x-user-defined");d.clientInterface.updateStatus("Contacting server...");i.send(a)},r=function(a,b){var c=d.getFingerprint();if(c){c=c.wifiInfo;!c||c.length===0?d.clientInterface.errorHandler("No WiFi data available."):G(x(a,b,A(c)))}else d.clientInterface.errorHandler("Failed to send request. No Fingerprint given! Did you forget to call tagin.setFingerprint() function?")}, t=null;d.dataManager={};d.dataManager.WiFi=function(a,b,c,e){this.mac=a;this.strength=b;this.channel=c;this.mode=e};d.dataManager.GPS=function(a,b){this.lat=a;this.lon=b};d.dataManager.Fingerprint=function(a,b){if(b)if(b instanceof d.dataManager.GPS)throw"Invalid GPS data given. GPS data must a GPS object";if(!(a instanceof Array))throw"Invalid scan data given. Scan data must be an array of WiFi objects";for(var c=0;c<a.length;c++)if(!a[c]instanceof d.dataManager.WiFi)throw"Invalid WiFi data given. Scan data must be an array of WiFi objects"; this.wifiInfo=a;this.gpsInfo=b};d.dataManager.Tag=function(a,b,c){this.value=a;this.distance=b;this.frequency=c};d.dataManager.Location=function(a,b,c,e,g,j,p,q){this.room=a;this.floor=b;this.building=c;this.street=e;this.city=g;this.province=j;this.country=p;this.postal=q};d.serverResponse={};d.serverResponse.Response=function(a,b){this.responseType=a;this.responseData=b;this.getResponseType=function(){return this.responseType};this.getResponseData=function(){return this.responseData}};d.loadTagin= function(a){if(!a)throw"No GUI Interface given.";if(!v(a,u))throw"Invalid GUI Interface given.";if(!m){d.clientInterface=a;m=true}};d.unloadTagin=function(){d.clientInterface=null;m=false};d.setFingerprint=function(a){if(!(a instanceof d.dataManager.Fingerprint))throw"Invalid Fingerprint given";t=a};d.getFingerprint=function(){return t};d.requestAllVisibleTags=function(){k();r("request_all_visible_tags",null)};d.requestCurrentLocation=function(){k();r("request_current_location",null)};d.requestRefreshedData= function(){k();d.requestAllVisibleTags();setTimeout(d.requestCurrentLocation,2E3)};d.addTags=function(a){k();(a=y(a))?r("add_tags",a):d.clientInterface.errorHandler("Error occured while parsing tags.")};d.addLocation=function(a){k();if(!(a instanceof d.dataManager.Location))throw"Invalid location given. Did you give an instance of tagin.dataManager.Location class?";(a=z(a))?r("add_location",a):d.clientInterface.updateStatus("Error generating location info.")}})(tagin);